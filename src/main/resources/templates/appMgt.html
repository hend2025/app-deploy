<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>应用管理</title>
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
    <!-- 导航栏 -->
    <div th:replace="fragments/navbar :: navbar"></div>

    <!-- 主要内容 -->
    <div class="container-fluid h-100" style="padding: 15px;">
        <div class="row h-100">
            <div class="col-12 d-flex flex-column">
                <!-- 搜索和操作区域 -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center mb-2">
                            <div class="col-md-9">
                                <div class="d-flex align-items-center gap-2">
                                    <label class="form-label mb-0" style="min-width: 80px;">搜索应用</label>
                                    <input type="text" id="searchInput" class="form-control flex-fill" placeholder="输入应用名称搜索...">
                                    <button class="btn btn-primary" onclick="searchApps()" style="min-width: 80px; padding: 8px 16px;">
                                        搜索
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 应用列表 -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>应用名称</th>
                                        <th>版本号</th>
                                        <th>状态</th>
                                        <th>更新时间</th>
                                        <th style="width: 200px; text-align: center;">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="appTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            加载中...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    
    <style>
        /* 全屏布局基础样式 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        body {
            display: flex;
            flex-direction: column;
        }
        
        .container-fluid.h-100 {
            height: calc(100vh - 76px); /* 减去导航栏高度 */
        }
        
        
        /* 表格样式优化 */
        .table th {
            border-top: none;
            font-weight: 600;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        /* 操作按钮样式 */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        
        /* 空间优化 */
        .card-body {
            padding: 1rem;
        }
        
        .table-responsive {
            margin-top: 0.5rem;
        }
    </style>

    <script>
        $(document).ready(function() {
            searchApps();
            
            // 搜索框回车事件
            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) {
                    searchApps();
                }
            });
            
            // 启动自动刷新
            startAutoRefresh();
        });

        // 搜索应用
        function searchApps() {
            const searchText = $('#searchInput').val();
            $.ajax({
                url: '/deploy/appMgt/list',
                method: 'GET',
                data: { appCode: searchText },
                success: function(response) {
                    if (response.success) {
                        appList = response.data; // 更新全局变量
                        displayApps(response.data);
                    } else {
                        showAlert('搜索失败: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('搜索失败: ' + error, 'danger');
                }
            });
        }

        // 显示应用列表
        function displayApps(apps) {
            const tbody = $('#appTableBody');
            tbody.empty();
            
            if (appList.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            暂无数据
                        </td>
                    </tr>
                `);
                return;
            }
            
            // 按照应用ID升序排序
            const sortedApps = appList.sort(function(a, b) {
                // 如果appCode是纯数字，按数字排序；否则按字符串排序
                const aIsNumber = !isNaN(a.appCode) && !isNaN(parseInt(a.appCode));
                const bIsNumber = !isNaN(b.appCode) && !isNaN(parseInt(b.appCode));
                
                if (aIsNumber && bIsNumber) {
                    return parseInt(a.appCode) - parseInt(b.appCode);
                } else if (aIsNumber && !bIsNumber) {
                    return -1; // 数字排在字符串前面
                } else if (!aIsNumber && bIsNumber) {
                    return 1; // 字符串排在数字后面
                } else {
                    return a.appCode.localeCompare(b.appCode); // 字符串按字典序排序
                }
            });
            
            sortedApps.forEach(function(app) {
                const statusBadge = getStatusBadge(app.status);
                const row = `
                    <tr>
                        <td><strong>${app.appCode}</strong></td>
                        <td><span class="badge bg-info">${app.version || '-'}</span></td>
                        <td>${statusBadge}</td>
                        <td>${formatDateTime(app.updateTime)}</td>
                        <td style="text-align: right;">
                            <div class="d-flex gap-1 justify-content-end">
                                ${!app.pid ? 
                                    `<button class="btn btn-sm btn-outline-success" onclick="startApp('${app.appCode}')" title="启动">
                                        启动
                                    </button>` : 
                                    `<button class="btn btn-sm btn-outline-secondary" disabled title="进程已运行">
                                        启动
                                    </button>`
                                }
                                ${app.pid ? 
                                    `<button class="btn btn-sm btn-outline-warning" onclick="stopApp('${app.appCode}', '${app.pid}')" title="停止进程">
                                        停止
                                    </button>` : 
                                    `<button class="btn btn-sm btn-outline-secondary" disabled title="进程未运行">
                                        停止
                                    </button>`
                                }
                                <button class="btn btn-sm btn-outline-info" onclick="viewLogs('${app.appCode}')" title="日志">
                                    日志
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        // 获取状态徽章
        function getStatusBadge(status) {
            if (!status) return '<span class="badge bg-secondary">未知</span>';
            
            switch(status) {
                case '1':
                    return '<span class="badge bg-primary">就绪</span>';
                case '2':
                    return '<span class="badge bg-success">运行</span>';
                default:
                    return `<span class="badge bg-secondary">${status}</span>`;
            }
        }


        // 启动应用
        function startApp(appCode) {
            // 从应用列表中获取版本号和参数
            const app = appList.find(a => a.appCode === appCode);
            const version = app ? app.version || '-' : '-';
            
            // 获取后台的启动参数，如果为空则使用默认值
            let params = app && app.params ? app.params : '';
            
            // 如果后台参数为空，使用默认参数
            if (!params || params.trim() === '') {
                params = `-Xmx1048m
-Xms512m
-Dfile.encoding=utf-8
-Dsun.jnu.encoding=UTF-8
-Ddubbo.registry.address=zookeeper://127.0.0.1:2181
-Ddubbo.metadata-report.address=zookeeper://127.0.0.1:2181
-Dnacos_host=192.168.10.147:8848
-Dspring.cloud.nacos.config.namespace=hsa-ims-scen-hend
-Dlogging.level.root=info`;
            }
            
            // 创建启动弹窗
            const modalHtml = `
                <div class="modal fade" id="startModal" tabindex="-1" aria-labelledby="startModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="startModalLabel">启动应用</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="startForm">
                                    <div class="mb-3">
                                        <div class="row align-items-end">
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center gap-2">
                                                    <label class="form-label mb-0" style="min-width: 80px;">应用编码</label>
                                                    <input type="text" class="form-control" value="${appCode}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center gap-2">
                                                    <label class="form-label mb-0" style="min-width: 60px;">版本号</label>
                                                    <input type="text" class="form-control" id="appVersion" value="${version}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="params" class="form-label">启动参数</label>
                                        <textarea class="form-control" id="params" rows="10" style="font-family: monospace; font-size: 14px;">${params}</textarea>
                                        <div class="form-text">支持多行输入，每行一个参数</div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-success" onclick="confirmStart('${appCode}')">确定启动</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            $('#startModal').remove();
            
            // 添加新的模态框
            $('body').append(modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('startModal'));
            modal.show();
        }

        // 确认启动
        function confirmStart(appCode) {
            const params = $('#params').val().trim();
            const appVersion = $('#appVersion').val().trim();

            // 发送启动请求到后台
            $.ajax({
                url: '/deploy/appMgt/start',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    appCode: appCode,
                    version: appVersion,
                    params: params
                }),
                success: function(response) {
                    if (response.success) {
                        showAlert(`应用启动成功: ${appCode}`, 'success');
                        
                        // 关闭模态框
                        $('#startModal').modal('hide');
                        
                        // 刷新列表
                        searchApps();
                    } else {
                        showAlert('启动应用失败: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = error;
                    if (xhr.responseText) {
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            errorMessage = errorResponse.message || error;
                        } catch (e) {
                            errorMessage = xhr.responseText;
                        }
                    }
                    showAlert('启动应用失败: ' + errorMessage, 'danger');
                }
            });
        }

        // 停止应用
        function stopApp(appCode, pid) {
            // 从列表中查找应用名称
            const app = appList.find(a => a.appCode === appCode);

            // 创建停止确认弹窗
            const modalHtml = `
                <div class="modal fade" id="stopModal" tabindex="-1" aria-labelledby="stopModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title" id="stopModalLabel">
                                    <i class="bi bi-exclamation-triangle-fill"></i> 确认停止应用
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning mb-3" role="alert">
                                    <i class="bi bi-exclamation-circle"></i> 此操作将强制终止应用进程
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">应用名称</label>
                                    <div class="form-control-plaintext border rounded p-2 bg-light">
                                        ${appCode}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">进程ID</label>
                                    <div class="form-control-plaintext border rounded p-2 bg-light">
                                        <code class="text-danger">${pid}</code>
                                    </div>
                                </div>
                                <p class="text-muted mb-0">
                                    <small>注意：停止后应用将无法继续运行，请确认后再执行此操作。</small>
                                </p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle"></i> 取消
                                </button>
                                <button type="button" class="btn btn-danger" onclick="confirmStop('${appCode}', '${pid}')">
                                    <i class="bi bi-stop-circle"></i> 确定停止
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            $('#stopModal').remove();
            
            // 添加新的模态框
            $('body').append(modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('stopModal'));
            modal.show();
        }

        // 确认停止
        function confirmStop(appCode, pid) {
            // 发送停止请求到后台
            $.ajax({
                url: '/deploy/appMgt/stop',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    appCode: appCode,
                    pid: pid
                }),
                success: function(response) {
                    if (response.success) {
                        showAlert('应用已停止', 'success');
                        
                        // 关闭模态框
                        $('#stopModal').modal('hide');
                        
                        // 刷新列表
                        searchApps();
                    } else {
                        showAlert('停止应用失败: ' + response.message, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = error;
                    if (xhr.responseText) {
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            errorMessage = errorResponse.message || error;
                        } catch (e) {
                            errorMessage = xhr.responseText;
                        }
                    }
                    showAlert('停止应用失败: ' + errorMessage, 'danger');
                }
            });
        }

        // 查看日志
        function viewLogs(appCode) {
            // 从当前应用列表中查找日志文件
            const app = appList.find(a => a.appCode === appCode);
            
            if (!app || !app.logFile) {
                showAlert('该应用暂无日志文件', 'warning');
                return;
            }
            
            // 提取文件名（去掉路径）
            const fileName = app.logFile.split(/[/\\]/).pop();
            showLogModal(fileName);
        }

        // 显示日志弹窗
        function showLogModal(logFileName) {
            // 重置行数计数，确保每次打开都显示全量内容
            if (!window.logLineCounts) window.logLineCounts = {};
            window.logLineCounts[logFileName] = 0;
            
            const modalHtml = `
                <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-fullscreen">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="logModalLabel">日志详情 - ${logFileName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" style="padding: 0;">
                                <div id="logContent" style="height: calc(100vh - 130px); overflow-y: auto; background-color: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; font-family: monospace; white-space: pre-wrap; font-size: 14px; line-height: 1.4;">
                                    加载中...
                                </div>
                            </div>
                            <div class="modal-footer">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success" id="autoRefreshBtn" onclick="toggleLogAutoRefresh('${logFileName}')">自动刷新</button>
                                    <button class="btn btn-sm btn-info" onclick="scrollToBottom()">到底部</button>
                                    <button class="btn btn-sm btn-warning" onclick="clearLogContent()">清空</button>
                                    <button class="btn btn-sm btn-primary" onclick="downloadLog('${logFileName}')">下载</button>
                                </div>
                                <button type="button" class="btn btn-sm btn-primary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的日志模态框
            $('#logModal').remove();
            
            // 添加新的日志模态框
            $('body').append(modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('logModal'));
            modal.show();
            
            // 加载日志内容
            refreshLogContent(logFileName);
            
            // 自动开启自动刷新
            setTimeout(function() {
                toggleLogAutoRefresh(logFileName);
            }, 3000);
            
            // 监听模态框关闭事件，停止自动刷新
            $('#logModal').on('hidden.bs.modal', function() {
                stopLogAutoRefresh();
            });
        }

        // 刷新日志内容
        function refreshLogContent(logFileName) {
            const currentLineCount = window.logLineCounts[logFileName] || 0;
            
            // 如果是首次加载（行数为0），先加载最后3000行
            if (currentLineCount === 0) {
                $.ajax({
                    url: '/deploy/logs/file/read-file-last-lines',
                    method: 'GET',
                    data: { fileName: logFileName, lastLines: 3000 },
                    success: function(response) {
                        if (response.success) {
                            $('#logContent').text(response.content);
                            // 记录总行数，用于后续增量查询
                            window.logLineCounts[logFileName] = response.totalLines;
                        } else {
                            $('#logContent').text('加载日志失败: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        let errorMsg = '加载日志失败: ';
                        if (xhr.responseText) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                errorMsg += response.message || response.error || error;
                            } catch (e) {
                                errorMsg += xhr.responseText || error;
                            }
                        } else {
                            errorMsg += error || status || '未知错误';
                        }
                        $('#logContent').text(errorMsg);
                    }
                });
            } else {
                // 后续加载使用增量方式
                $.ajax({
                    url: '/deploy/logs/file/read-file-incremental',
                    method: 'GET',
                    data: { fileName: logFileName, fromLine: currentLineCount },
                    success: function(response) {
                        if (response.success && response.hasNewContent) {
                            // 有新内容，追加到现有内容
                            appendNewLogContent(response.content);
                            // 更新行数计数
                            window.logLineCounts[logFileName] = response.totalLines;
                        }
                    },
                    error: function(xhr, status, error) {
                        // 静默处理错误，避免频繁显示错误信息
                    }
                });
            }
        }

        // 追加新的日志内容
        function appendNewLogContent(newContent) {
            const $logContent = $('#logContent');
            const existingContent = $logContent.text();
            $logContent.text(existingContent + newContent);
            
            // 自动滚动到底部
            const logContainer = document.getElementById('logContent');
            if (logContainer) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // 日志自动刷新相关变量
        let logAutoRefreshInterval = null;

        // 切换日志自动刷新状态
        function toggleLogAutoRefresh(logFileName) {
            if (logAutoRefreshInterval) {
                // 当前正在自动刷新，停止它
                clearInterval(logAutoRefreshInterval);
                logAutoRefreshInterval = null;
                $('#autoRefreshBtn').text('自动刷新').removeClass('btn-warning').addClass('btn-success');
            } else {
                // 当前没有自动刷新，开始它
                // 立即刷新一次
                refreshLogContent(logFileName);
                
                // 设置3秒自动刷新
                logAutoRefreshInterval = setInterval(function() {
                    refreshLogContent(logFileName);
                }, 3000);
                
                $('#autoRefreshBtn').text('停止刷新').removeClass('btn-success').addClass('btn-warning');
            }
        }

        // 停止日志自动刷新（供模态框关闭时调用）
        function stopLogAutoRefresh() {
            if (logAutoRefreshInterval) {
                clearInterval(logAutoRefreshInterval);
                logAutoRefreshInterval = null;
            }
        }

        // 清空日志内容
        function clearLogContent() {
            $('#logContent').text('');
        }

        // 滚动到底部
        function scrollToBottom() {
            const logContainer = document.getElementById('logContent');
            if (logContainer) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // 下载日志
        function downloadLog(fileName) {
            if (!fileName) {
                showAlert('该应用没有日志文件', 'warning');
                return;
            }
            window.open('/deploy/logs/file/download-file?fileName=' + encodeURIComponent(fileName), '_blank');
        }

        // 格式化日期时间
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-CN');
        }
        
        // 显示提示信息
        function showAlert(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'danger' ? 'alert-danger' : 
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const notification = $(`
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('body').append(notification);
            
            // 3秒后自动消失
            setTimeout(function() {
                notification.alert('close');
            }, 3000);
        }

        // 自动刷新相关变量
        let listAutoRefreshInterval = null;
        
        // 启动列表自动刷新
        function startAutoRefresh() {
            // 每15秒检查一次是否需要刷新
            listAutoRefreshInterval = setInterval(function() {
                searchApps();
            }, 15000);
        }
        
        // 停止列表自动刷新
        function stopListAutoRefresh() {
            if (listAutoRefreshInterval) {
                clearInterval(listAutoRefreshInterval);
                listAutoRefreshInterval = null;
            }
        }
    </script>
</body>
</html>
